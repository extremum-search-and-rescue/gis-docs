---
title: Служебная страница сервиса геолокации
date: 2023-08-26
layout: post
---

## Ссылки и соединение

> ##### Внимание
> Пожалуйста, не надо нажимать на все ссылки подряд, они приведены для информации, а не для экспериментирования.
{: .block-warning }

**Пользователь открывает ссылку на страницу определения координат**

Ссылка открывается в браузере на мобильном устройстве пользователя. Из-за требований браузеров после 2017 года определение координат требует безопасного соединения, такая ссылка начинается с HTTP**S**.

|Год последнего обновления устройства|Ссылка
|:-:|:-:|
|после 2017 года|https://gps.extremum.org|
|устаревшие, до 2017 года|http://gps.extremum.org|

Ссылки лучше всего отправлять с помощью SMS. Доставка SMS надёжна, а расход заряда на их получение в десятки тысяч раз меньше, чем получение сообщения через какой-нибудь мессенджер, которому обязательно надо будет проверить и скачать все новые аватарки контактов и чатов, узнать, что у кого нового, нет ли обновлений, и интенсивно пообщаться со своими серверами. Расход заряда на это неуместен при проведении поисково-спасательных работ.

Если отправить вторую ссылку новому устройству, то произойдёт много ненужной суеты. Устройство в процессе подключения к серверу выяснит, что существует первая ссылка, и переподключится туда, совершая лишний расход времени и трафика с соответствующими рисками. Отправляйте второй вариант, если вы заранее знаете, что устройство очень старое, или первая ссылка не открывается с ошибкой о небезопасности.

> Чтобы установить безопасное соединение, устройство должно доверять центру сертификации, который подтверждает подлинность сайта определения координат. Устройства, которые были последний раз обновлены до 2015 года могут не доверять новым центрам сертификации и показывать ошибку. Но, так как до 2017 года для определения координат браузерам не требовалось безопасное соедениение, то будет нормально отправить ссылку без http, кроме того, само соединение будет установлено быстрее.
>
> Соединение устанавливается по одной из версий протокола HTTP 1.1, 2 или 3. В процессе соединения сервер сообщает о своих возможностях клиентскому устройству, и оно будет использовать самый современный из известных ему вариантов. Более поздние протоколы имеют огромное преимущество в нестабильных сетях, особенно хорошо работает HTTP3 для которого переподключение мобильного устройства пользователя к разным базовым станциям сотовой связи не означает гарантированный обрыв соединения, как это происходит со старыми сервисами. Если вы видели когда-нибудь сообщение вида ERR_NETWORK_CHANGED в браузере, то такое происходит только на старых версиях протоколов, если устройство переподключается к разным сетям в процессе работы. У нас переподключение сколько-нибудь современных устройств происходит без подобных ошибок.
>
> Устройство в процессе соединения всегда сообщает серверу свои возможности по приёму сжатого трафика. Сервер выбирает лучший поддерживаемый алгоритм сжатия, использует его и упаковывает свои ответы с максимальными настройками. Кроме того, страницы отправляемые клиенту, упрощаются до предела: из них удаляетется всё, что не критически необходимо для работы, поэтому ответ сервера в десятки тысяч раз компактнее, чем скачивание приложения, и как минимум в десятки раз меньше, чем страницы без подобных ухищрений. Сжатые данные скачиваются намного быстрее, а это сокращает расход заряда устройства. Распаковка данных на порядки менее энергоёмкая операция, чем подключения к медленным нестабильным сетям.

## Заход устройства и подготовка к работе  

|Сообщение|Смысл|
|-|:-|
|Заход|Устройство обратилось к странице и загрузило её содержимое. Значит, что связь есть, устройство может запрашивать и отправлять данные.|
||Первый заход|
||Не первый заход. Означает, что устройство уже заходило, получило и хранит свой идентификатор. Если такое происходит внутри одного сеанса, то это нормально, просто второй раз нажали на ссылку. Если сеанс начинается именно с этого, возможно, что потерявшийся — «рецидивист». А может быть это пользователь ГИС для ПСО, который никак не может запомнить, на какую страницу нужно заходить. Не будьте такими пользователями.|
|Ответ|Когда устройство открывает страницу, оно отчитывается сервису о том, что страница полностью загрузилась, и готова к использованию. Это важнейший диагностический критерий. Только в этот момент на gis.extremum.org при включённом слое геолокации приходит уведомление «новый заход».|
|Компас|Появляется, когда сервер отмечает загрузку страницы компаса. Показывает запрошенный азимут.|
|Дозагрузка|Страница подготавливает запчасти для последующей работы без сети. Происходит с задержкой десять секунд после начала работы и позволяет не мешать передаче остальных данных. Это значит, что в следующий раз та же самая страница на устройстве может открыться уже без Захода, а сразу на стадии Ответ. Просто потому, что заход будет не на сервер, а в специальное хранилище, куда только что и были загружены «запчасти». Радикально повышает надёжность и экономит время при повторных открытиях страницы в условиях нестабильной сети.|
||Оффлайн недоступен. Это сообщение появляется вместо предыдущего. Во время подготовки к работе без сети оказалось, что данное устройство не сможет работать без сети (см. Дозагрузка). Обычно, потому что браузер очень старый, и не поддерживает такие технологии. В этом случае такое старое устройство может иметь проблемы безопасного соединения. Иногда на подобные устройства имеет смысл отправлять второй варианты ссылки (см. Ссылки и соединение). Если браузер современный, то это может означать что пользователь пришёл в геолокацию в режиме Инкогнито, что очень-очень странно. Определять координаты это не помешает, но ситуация вызывает вопросы.|
|0-2|Диагностическое сообщение одного из трёх следующих видов.|
||"Запрос о доступе к местоположению возможен. Сейчас спросим" — означает, что мы проверили, в каком состоянии находится разрешение геолокации, и оно может «спрашивать». Это нормальное, удачное для нас состояние.|
||"Доступ к местоположению был разрешён на момент открытия страницы. Не первый раз?" — редкая история при первом заходе. Получается, что мы сейчас будем определять координаты без подтверждения пользователя. При этом часто встречается, когда пользователь уже заходил ранее и положительно ответил на наш запрос.|
||"Доступ к местоположению был запрещён ещё до захода по ссылке. Ждать бесполезно. Нужно или давать инструкцию о том, как разрешить доступ, либо пробовать какие-то другие способы или приложения" — если это первый заход, то любой сервис геолокации закончит тем же: невозможностью получить точные координаты. Но может просто пользователь в предыдущий раз уже нажал не туда, это редко, но бывает.|

> Если устройство заходит, но не отчитывается, значит с ним что-то не так. Возможно, оно очень старое, тогда это будет видно по номеру версии. А может быть это только что был не потерявшийся, а пришёл какой-нибудь бот, который ищет уязвимости в сайтах. Бот только загружает страницу, но не выполняет её код.

## Определение координат

|Способ|Смысл
|-|:-|
|0-3|Ненастоящий способ узнать местоположение пользователя. Попытка определить координаты по IP адресу. Сносно срабатывает в населённых пунктах и даже в помещениях. Вообще не зависит от разрешения определять координаты. В случае, когда устройство подключено к Wi-Fi сети, данные могут быть довольно точными. В природной среде обычно бесполезен.|
|1-1-?|Быстрая попытка получить данные любой, даже самой низкой точности и давности.|
|1-2-?|Попытка получить данные любой, даже самой низкой точности и давности, немного подождав.|
|1-2-?|Попытка получить более-менее свежие данные, даже самой низкой точности, немного подождав.|
|2-1-?|Попытка получить данные высокой точности любой давности.|
|2-2-?|Попытка получить свежие данные высокой точности.|
|3-?|Попытки получить данные высокой точности, обновление каждые несколько секунд. Если данные приходят этим способом, то они и актуальные, и точные настолько, насколько это возможно на данном устройстве. В этом режиме устройство всё время будет запрашивать координаты, и, если с ним идти, и оставить устройство включённым, то будет «хвост» из звёздочек геолокации по маршруту движения. Помните, что определение координат - энергозатратный процесс, а их отправка удваивает эту величину. Поэтому отправляются только те местоположения, которые отличаются примерно на десять метров, или у них значительно отличается точность. В движении расход батарейки на определение координат и отправку, соответственно, возрастает.|

## Диагностические сообщения с ошибками

<div class="table-wrapper" markdown="block">
  
|Ошибка|Комментарий|
|-|:-|
|TIMEOUT|Это скорее не ошибка, а нормальное состояние, когда местоположение нельзя определить мгновенно. Если координаты не приходят, а в диагностическом сообщении 0-2 нет явного запрета, это чаще всего значит, что пользователь не смог выполнить инструкцию дождаться высокой точности координат. Иногда процесс определения координат может занимать до пары минут, такое особенно часто может происходить с устройствами пожилых людей, на которых мало программ, интересующихся их местоположением с высокой точностью.|
|PERMISSION_DENIED|Надо смотреть какой вариант:|
||Похоже, что пользователь сам только что нажал 'Запретить' (Ошибка: PERMISSION_DENIED). Предложили другую ссылку >> https://geo.extremum.org — между запросом координат и ответом прошло время, похожее на то, что запрос координат появился, но пользователь нажал не туда, куда мы ожидали.|
||Доступ к местоположению был запрещён (Ошибка: PERMISSION_DENIED) — если до этого уже была ошибка, то увы.|
|POSITION_UNAVAILABLE|Может быть в случае, когда на устройстве нет модуля GPS/GLONASS, так бывает. Стоит проверить, что за устройство, если это очень дешёвое устройство, такое может быть порядке вещей, но, скорее всего, это показывает не просто на то, что браузеру запрещено определение местоположения, а оно запрещено либо всем приложениям вообще, либо браузеру, но каким-то очень сложным способом.|

</div>

## Частые вопросы

**Вопрос**: Очень много букв, можно попроще?

**Ответ**: зайдите на https://gps.extremum.org и включите доступные слои геолокации. Ищите оранжевую звёздочку координат в примерном районе местонахождения потерявшегося.

<hr>

**Вопрос**: Мы это всё внимательно прочитали и запилили ещё один прекрасный сервис определения координат, который почти так же хорош. Как нам его подключить к системе?

**Ответ**: Никак. Работа по подключению и поддержке таких сервисов непроста, они часто недостаточно стабильны и требуют много внимания, а пользуются ими три человека в год. Часто время их жизни невелико, обычно пара лет, пока не закончится энтузиазм авторов. Это нерационально, даже время затраченное на обсуждение интеграции не окупается временем использования.
